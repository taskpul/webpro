import{C as Z,b as X,u as oe,S as re,a as te}from"./chunk-O74UDEWT-D8lYkzVr.js";import{S as ae,C as D}from"./chunk-PYIO3TDQ-D8Zv8hXV.js";import{f as le}from"./chunk-IR5DHEKS-aVJcUHa1.js";import{u as B}from"./chunk-HFB3OQXI-CgJWO1Kt.js";import{C as q}from"./chunk-2PMSBTXI-B-DQ21hS.js";import{D as ce}from"./chunk-UWJBDOQD-KzHItMai.js";import{S as pe}from"./chunk-D7H6ZNK4-DuqkGbL3.js";import{c as M}from"./chunk-6GU6IDUA-CDc7wW5L.js";import{K as de}from"./chunk-6HTZNHPT-XB1WuBsp.js";import{R as w,u as Y,a as ue,S as he}from"./chunk-4TC5YS65-CQLRrj-3.js";import{ap as W,ar as _,ex as me,as as ge,au as z,aB as J,ab as fe,an as xe,bR as _e,aV as Q,j as e,r as O,b as ee,aw as je,ax as ye,N as se,fD as be,t as U,B as A,s as H,H as Ce,Z as Se,W as n,X as ve,at as T,V as Oe,v as Pe,x as we,y as Le}from"./index-DdOSbXML.js";import{b as Ee}from"./chunk-GRT22PE5-Bh_4tQNx.js";import{P}from"./progress-tabs-B0UnEtD-.js";import{R as G}from"./radio-group-bYQ_4UAu.js";import"./chunk-X6BAAGCL-BZtcqqR7.js";import"./chunk-DK4WIVY6-CYCbBMOO.js";import"./Trans-vJDrnLfE.js";import"./_isIndex-Cj2VejAI.js";import"./index-B-otT4yT.js";var ke=({form:a,isReturn:g=!1,zone:j,locationId:b,fulfillmentProviderOptions:h,selectedProviderId:x,type:y})=>{const{t}=ee(),p=y==="pickup",d=B({queryFn:s=>H.admin.shippingProfile.list(s),queryKey:["shipping_profiles"],getOptions:s=>s.shipping_profiles.map(i=>({label:i.name,value:i.id}))}),r=B({queryFn:s=>H.admin.shippingOptionType.list(s),queryKey:["shipping_option_types"],getOptions:s=>s.shipping_option_types.map(i=>({label:i.label,value:i.id}))}),u=B({queryFn:s=>H.admin.fulfillmentProvider.list({...s,stock_location_id:b}),queryKey:["fulfillment_providers"],getOptions:s=>s.fulfillment_providers.map(i=>({label:le(i.id),value:i.id}))});return e.jsx("div",{className:"flex flex-1 flex-col items-center overflow-y-auto",children:e.jsxs("div",{className:"flex w-full max-w-[720px] flex-col gap-y-8 px-6 py-16",children:[e.jsxs("div",{children:[e.jsx(Ce,{children:t(`stockLocations.shippingOptions.create.${p?"pickup":g?"returns":"shipping"}.header`,{zone:j.name})}),e.jsx(Se,{size:"small",className:"text-ui-fg-subtle",children:t(`stockLocations.shippingOptions.create.${g?"returns":p?"pickup":"shipping"}.hint`)})]}),!p&&e.jsx(n.Field,{control:a.control,name:"price_type",render:({field:s})=>e.jsxs(n.Item,{children:[e.jsx(n.Label,{children:t("stockLocations.shippingOptions.fields.priceType.label")}),e.jsx(n.Control,{children:e.jsxs(G,{className:"grid grid-cols-1 gap-4 md:grid-cols-2",...s,onValueChange:s.onChange,children:[e.jsx(G.ChoiceBox,{className:"flex-1",value:"flat",label:t("stockLocations.shippingOptions.fields.priceType.options.fixed.label"),description:t("stockLocations.shippingOptions.fields.priceType.options.fixed.hint")}),e.jsx(G.ChoiceBox,{className:"flex-1",value:"calculated",label:t("stockLocations.shippingOptions.fields.priceType.options.calculated.label"),description:t("stockLocations.shippingOptions.fields.priceType.options.calculated.hint")})]})}),e.jsx(n.ErrorMessage,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx(n.Field,{control:a.control,name:"name",render:({field:s})=>e.jsxs(n.Item,{children:[e.jsx(n.Label,{children:t("fields.name")}),e.jsx(n.Control,{children:e.jsx(ve,{...s})}),e.jsx(n.ErrorMessage,{})]})}),e.jsx(n.Field,{control:a.control,name:"shipping_profile_id",render:({field:s})=>e.jsxs(n.Item,{children:[e.jsx(n.Label,{children:t("stockLocations.shippingOptions.fields.profile")}),e.jsx(n.Control,{children:e.jsx(q,{...s,options:d.options,searchValue:d.searchValue,onSearchValueChange:d.onSearchValueChange,disabled:d.disabled})}),e.jsx(n.ErrorMessage,{})]})}),e.jsx(n.Field,{control:a.control,name:"shipping_option_type_id",render:({field:s})=>e.jsxs(n.Item,{children:[e.jsx(n.Label,{children:t("stockLocations.shippingOptions.fields.type")}),e.jsx(n.Control,{children:e.jsx(q,{...s,options:r.options,searchValue:r.searchValue,onSearchValueChange:r.onSearchValueChange,disabled:r.disabled})}),e.jsx(n.ErrorMessage,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx(n.Field,{control:a.control,name:"provider_id",render:({field:s})=>e.jsxs(n.Item,{children:[e.jsx(n.Label,{tooltip:t("stockLocations.fulfillmentProviders.shippingOptionsTooltip"),children:t("stockLocations.shippingOptions.fields.provider")}),e.jsx(n.Control,{children:e.jsx(q,{...s,onChange:i=>{s.onChange(i),a.setValue("fulfillment_option_id","")},options:u.options,searchValue:u.searchValue,onSearchValueChange:u.onSearchValueChange,disabled:u.disabled})}),e.jsx(n.ErrorMessage,{})]})}),e.jsx(n.Field,{control:a.control,name:"fulfillment_option_id",render:({field:s})=>e.jsxs(n.Item,{children:[e.jsx(n.Label,{children:t("stockLocations.shippingOptions.fields.fulfillmentOption")}),e.jsx(n.Control,{children:O.createElement(T,{...s,onValueChange:s.onChange,disabled:!x,key:x},e.jsx(T.Trigger,{ref:s.ref,children:e.jsx(T.Value,{})}),e.jsx(T.Content,{children:h==null?void 0:h.filter(i=>!!i.is_return===g).map(i=>e.jsx(T.Item,{value:i.id,children:i.name||i.id},i.id))}))}),e.jsx(n.ErrorMessage,{})]})})]}),e.jsx(Oe,{}),e.jsx(pe,{control:a.control,name:"enabled_in_store",label:t("stockLocations.shippingOptions.fields.enableInStore.label"),description:t("stockLocations.shippingOptions.fields.enableInStore.hint")})]})})},Te=({form:a,type:g})=>{const j=g==="pickup",{getIsOpen:b,setIsOpen:h}=ue(),[x,y]=O.useState(null),t=l=>{h(D,!0),y(l)},p=()=>{h(D,!1),y(null)},{store:d,isLoading:r,isError:u,error:s}=Pe(),i=O.useMemo(()=>{var l;return((l=d==null?void 0:d.supported_currencies)==null?void 0:l.map(S=>S.currency_code))||[]},[d]),{regions:f,isLoading:N,isError:F,error:L}=we({fields:"id,name,currency_code",limit:999}),{price_preferences:R}=Le({}),{setCloseOnEscape:K}=Y(),V=se({control:a.control,name:"name"}),I=oe({name:V,currencies:i,regions:f,pricePreferences:R}),o=r||!d||N||!f,C=O.useMemo(()=>[[...i||[],...f||[]]],[i,f]);if(O.useEffect(()=>{!o&&j&&(i.length>0&&i.forEach(l=>{a.setValue(`currency_prices.${l}`,"0")}),f.length>0&&f.forEach(l=>{a.setValue(`region_prices.${l.id}`,"0")}))},[o,j]),u)throw s;if(F)throw L;return e.jsx(he,{id:D,onOpenChangeCallback:l=>{l||y(null)},children:e.jsx(re,{onOpenConditionalPricesModal:t,onCloseConditionalPricesModal:p,children:e.jsxs("div",{className:"flex size-full flex-col divide-y overflow-hidden",children:[e.jsx(ce,{isLoading:o,data:C,columns:I,state:a,onEditingChange:l=>K(!l),disableInteractions:b(D)}),x&&e.jsx(te,{info:x,variant:"create"})]})})})},ie=W({name:_().min(1),price_type:me(ae),enabled_in_store:ge(),shipping_profile_id:_().min(1),provider_id:_().min(1),fulfillment_option_id:_().min(1),shipping_option_type_id:_().min(1)}),Ne=W({conditional_region_prices:z(_(),J(Z).optional()),conditional_currency_prices:z(_(),J(Z).optional())}),Fe=W({region_prices:z(_(),_().optional()),currency_prices:z(_(),_().optional())}).merge(ie).merge(Ne);function Ve({zone:a,isReturn:g,locationId:j,type:b}){var V,I;const[h,x]=O.useState("details"),[y,t]=O.useState(!1),{t:p}=ee(),{handleSuccess:d}=Y(),r=je({defaultValues:{name:"",price_type:"flat",enabled_in_store:!0,shipping_profile_id:"",provider_id:"",fulfillment_option_id:"",region_prices:{},currency_prices:{},conditional_region_prices:{},conditional_currency_prices:{}},resolver:ye(Fe)}),u=se({control:r.control,name:"provider_id"}),{fulfillment_options:s}=be(u,{enabled:!!u}),i=r.watch("price_type")==="calculated",{mutateAsync:f,isPending:N}=Ee(),F=r.handleSubmit(async o=>{const C=Object.entries(o.currency_prices).map(([c,m])=>{if(m)return{currency_code:c,amount:M(m)}}).filter(c=>!!c),l=Object.entries(o.region_prices).map(([c,m])=>{if(m)return{region_id:c,amount:M(m)}}).filter(c=>!!c),S=Object.entries(o.conditional_region_prices).flatMap(([c,m])=>{const v=(m==null?void 0:m.map(k=>({region_id:c,amount:M(k.amount),rules:X(k)})))||[];return v==null?void 0:v.filter(Boolean)}),E=Object.entries(o.conditional_currency_prices).flatMap(([c,m])=>{const v=(m==null?void 0:m.map(k=>({currency_code:c,amount:M(k.amount),rules:X(k)})))||[];return v==null?void 0:v.filter(Boolean)}),$=[...C,...E,...l,...S],ne=s==null?void 0:s.find(c=>c.id===o.fulfillment_option_id);await f({name:o.name,price_type:o.price_type,service_zone_id:a.id,shipping_profile_id:o.shipping_profile_id,provider_id:o.provider_id,prices:$,data:ne,rules:[{value:g?"true":"false",attribute:"is_return",operator:"eq"},{value:o.enabled_in_store?"true":"false",attribute:"enabled_in_store",operator:"eq"}],type_id:o.shipping_option_type_id},{onSuccess:({shipping_option:c})=>{U.success(p(`stockLocations.shippingOptions.create.${g?"returns":"shipping"}.successToast`,{name:c.name})),d(`/settings/locations/${j}`)},onError:c=>{U.error(c.message)}})}),L=o=>{if(o==="pricing"){r.clearErrors();const C=ie.safeParse({...r.getValues()});if(!C.success){const[l,...S]=C.error.errors;for(const E of S){const $=E.path.join(".");r.setError($,{message:E.message,type:E.code})}r.setError(l.path.join("."),{message:l.message,type:l.code},{shouldFocus:!0}),t(!1);return}t(!0)}x(o)},R=(V=r.getFieldState("currency_prices"))!=null&&V.isDirty||(I=r.getFieldState("region_prices"))!=null&&I.isDirty||h==="pricing"?"in-progress":"not-started",K=y?"completed":"in-progress";return e.jsx(w.Form,{form:r,children:e.jsx(de,{className:"flex h-full flex-col",onSubmit:F,onKeyDown:o=>{const C=o.key==="Enter",l=o.metaKey||o.ctrlKey,S=h!=="pricing"&&!i;if(C&&(o.preventDefault(),!!l)){if(S){o.stopPropagation(),L("pricing");return}F()}},children:e.jsxs(P,{value:h,className:"flex h-full flex-col overflow-hidden",onValueChange:o=>L(o),children:[e.jsx(w.Header,{children:e.jsxs(P.List,{className:"border-ui-border-base -my-2 ml-2 min-w-0 flex-1 border-l",children:[e.jsx(P.Trigger,{value:"details",status:K,className:"w-full max-w-[200px]",children:e.jsx("span",{className:"w-full cursor-auto overflow-hidden text-ellipsis whitespace-nowrap",children:p("stockLocations.shippingOptions.create.tabs.details")})}),!i&&e.jsx(P.Trigger,{value:"pricing",status:R,className:"w-full max-w-[200px]",children:e.jsx("span",{className:"w-full overflow-hidden text-ellipsis whitespace-nowrap",children:p("stockLocations.shippingOptions.create.tabs.prices")})})]})}),e.jsxs(w.Body,{className:"size-full overflow-hidden",children:[e.jsx(P.Content,{value:"details",className:"size-full overflow-y-auto",children:e.jsx(ke,{form:r,zone:a,isReturn:g,type:b,locationId:j,fulfillmentProviderOptions:s||[],selectedProviderId:u})}),e.jsx(P.Content,{value:"pricing",className:"size-full",children:e.jsx(Te,{form:r,type:b})})]}),e.jsx(w.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(w.Close,{asChild:!0,children:e.jsx(A,{variant:"secondary",size:"small",children:p("actions.cancel")})}),h==="pricing"||i?e.jsx(A,{size:"small",className:"whitespace-nowrap",isLoading:N,type:"submit",children:p("actions.save")},"submit-btn"):e.jsx(A,{size:"small",className:"whitespace-nowrap",isLoading:N,onClick:()=>L("pricing"),type:"button",children:p("actions.continue")},"continue-btn")]})})]})})})}var Ie="*fulfillment_sets,*fulfillment_sets.service_zones,*fulfillment_sets.service_zones.shipping_options";function ss(){var s,i;const{location_id:a,fset_id:g,zone_id:j}=fe(),[b]=xe(),h=b.has("is_return"),{stock_location:x,isPending:y,isFetching:t,isError:p,error:d}=_e(a,{fields:Ie}),r=(s=x==null?void 0:x.fulfillment_sets)==null?void 0:s.find(f=>f.id===g);if(!y&&!t&&!r)throw Q({message:`Fulfillment set with ID ${g} was not found`},404);const u=(i=r==null?void 0:r.service_zones)==null?void 0:i.find(f=>f.id===j);if(!y&&!t&&!u)throw Q({message:`Service zone with ID ${j} was not found`},404);if(p)throw d;return e.jsx(w,{prev:`/settings/locations/${a}`,children:u&&e.jsx(Ve,{zone:u,isReturn:h,locationId:a,type:r.type})})}export{ss as Component};
