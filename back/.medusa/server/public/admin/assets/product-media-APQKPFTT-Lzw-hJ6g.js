import{E as X,U as Z}from"./chunk-S45XMWVD-DjB7Dxbp.js";import"./chunk-ZQRKUG6J-BXE8_SJ6.js";import{r as j,b as P,ab as $,aa as ee,j as e,an as se,aw as te,ax as ae,Y as ie,z as ne,D as G,Q as re,R as le,ae as H,s as oe,t as K,B as I,L as F,E as de,F as ce,ag as T,S as ue,G as he,I as z,af as W,a3 as q,c as me,g as fe,J as D,T as xe,aO as pe,Z as O,aP as ge,aL as be}from"./index-DdOSbXML.js";import{K as je}from"./chunk-6HTZNHPT-XB1WuBsp.js";import{R as v,u as ve}from"./chunk-4TC5YS65-CQLRrj-3.js";import{s as ye,S as we,r as Te,u as Ce,a as Ne}from"./sortable.esm-_qKrBliI.js";import{T as B}from"./thumbnail-badge-Dxmeb3PN.js";import"./chunk-TYTNUPXB-oIRKBq4b.js";import"./chunk-6GU6IDUA-CDc7wW5L.js";var Se=({product:s})=>{const[t,i]=j.useState({}),{t:a}=P(),{handleSuccess:o}=ve(),m=te({defaultValues:{media:ke(s.images,s.thumbnail)},resolver:ae(X)}),{fields:l,append:n,remove:d,update:g}=ie({name:"media",control:m.control,keyName:"field_id"}),[h,p]=j.useState(null),N=ne(G(le),G(re,{coordinateGetter:ye})),y=r=>{p(r.active.id)},E=r=>{p(null);const{active:x,over:u}=r;if(x.id!==(u==null?void 0:u.id)){const b=l.findIndex(C=>C.field_id===x.id),A=l.findIndex(C=>C.field_id===(u==null?void 0:u.id));m.setValue("media",Ne(l,b,A),{shouldDirty:!0,shouldTouch:!0})}},c=()=>{p(null)},{mutateAsync:S,isPending:_}=H(s.id),M=m.handleSubmit(async({media:r})=>{var C;const x=r.map((f,k)=>({file:f.file,index:k})).filter(f=>!!f.file);let u=[];if(x.length){const{files:f}=await oe.admin.upload.create({files:x.map(k=>k.file)}).catch(()=>(m.setError("media",{type:"invalid_file",message:a("products.media.failedToUpload")}),{files:[]}));u=f}const b=r.map((f,k)=>{var U;const R=x.findIndex(Q=>Q.index===k);return R>-1?{...f,url:(U=u[R])==null?void 0:U.url}:f}),A=(C=b.find(f=>f.isThumbnail))==null?void 0:C.url;await S({images:b.map(f=>({url:f.url,id:f.id})),thumbnail:A||null},{onSuccess:()=>{K.success(a("products.media.successToast")),o()},onError:f=>{K.error(f.message)}})}),w=j.useCallback(r=>x=>{if(x)i(u=>({...u,[r]:!0}));else{const{[r]:u,...b}=t;i(b)}},[t]),Y=()=>{const x=Object.keys(t).map(u=>l.findIndex(b=>b.id===u));d(x),i({})},J=()=>{const r=Object.keys(t);if(!r.length)return;const x=l.findIndex(b=>b.isThumbnail);x>-1&&g(x,{...l[x],isThumbnail:!1});const u=l.findIndex(b=>b.id===r[0]);g(u,{...l[u],isThumbnail:!0}),i({})},L=Object.keys(t).length;return e.jsx(v.Form,{blockSearchParams:!0,form:m,children:e.jsxs(je,{className:"flex size-full flex-col overflow-hidden",onSubmit:M,children:[e.jsx(v.Header,{children:e.jsx("div",{className:"flex items-center justify-end gap-x-2",children:e.jsx(I,{variant:"secondary",size:"small",asChild:!0,children:e.jsx(F,{to:{pathname:".",search:void 0},children:a("products.media.galleryLabel")})})})}),e.jsx(v.Body,{className:"flex flex-col overflow-hidden",children:e.jsxs("div",{className:"flex size-full flex-col-reverse lg:grid lg:grid-cols-[1fr_560px]",children:[e.jsx(de,{sensors:N,onDragEnd:E,onDragStart:y,onDragCancel:c,children:e.jsx("div",{className:"bg-ui-bg-subtle size-full overflow-auto",children:e.jsxs("div",{className:"grid h-fit auto-rows-auto grid-cols-4 gap-6 p-6",children:[e.jsx(we,{items:l.map(r=>r.field_id),strategy:Te,children:l.map(r=>e.jsx(ze,{onCheckedChange:w(r.id),checked:!!t[r.id],media:r},r.field_id))}),e.jsx(ce,{dropAnimation:Ie,children:h?e.jsx(Pe,{media:l.find(r=>r.field_id===h),checked:!!t[l.find(r=>r.field_id===h).id]}):null})]})})}),e.jsx("div",{className:"bg-ui-bg-base overflow-auto border-b px-6 py-4 lg:border-b-0 lg:border-l",children:e.jsx(Z,{form:m,append:n})})]})}),e.jsx(T,{open:!!L,children:e.jsxs(T.Bar,{children:[e.jsx(T.Value,{children:a("general.countSelected",{count:L})}),e.jsx(T.Seperator,{}),L===1&&e.jsxs(j.Fragment,{children:[e.jsx(T.Command,{action:J,label:a("products.media.makeThumbnail"),shortcut:"t"}),e.jsx(T.Seperator,{})]}),e.jsx(T.Command,{action:Y,label:a("actions.delete"),shortcut:"d"})]})}),e.jsx(v.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(v.Close,{asChild:!0,children:e.jsx(I,{variant:"secondary",size:"small",children:a("actions.cancel")})}),e.jsx(I,{size:"small",type:"submit",isLoading:_,children:a("actions.save")})]})})]})})},ke=(s,t)=>{const i=(s==null?void 0:s.map(a=>({id:a.id,url:a.url,isThumbnail:a.url===t,file:null})))||[];if(t&&!i.some(a=>a.url===t)){const a=Math.random().toString(36).substring(7);i.unshift({id:a,url:t,isThumbnail:!0,file:null})}return i},Ie={sideEffects:ue({styles:{active:{opacity:"0.4"}}})},ze=({media:s,checked:t,onCheckedChange:i})=>{const{t:a}=P(),o=j.useCallback(y=>{i(y)},[i]),{attributes:m,listeners:l,setNodeRef:n,setActivatorNodeRef:d,transform:g,transition:h,isDragging:p}=Ce({id:s.field_id}),N={opacity:p?.4:void 0,transform:he.Transform.toString(g),transition:h};return e.jsxs("div",{className:z("shadow-elevation-card-rest hover:shadow-elevation-card-hover focus-visible:shadow-borders-focus bg-ui-bg-subtle-hover group relative aspect-square h-auto max-w-full overflow-hidden rounded-lg outline-none"),style:N,ref:n,children:[s.isThumbnail&&e.jsx("div",{className:"absolute left-2 top-2",children:e.jsx(W,{content:a("products.media.thumbnailTooltip"),children:e.jsx(B,{})})}),e.jsx("div",{className:z("absolute inset-0 cursor-grab touch-none outline-none",{"cursor-grabbing":p}),ref:d,...m,...l}),e.jsx("div",{className:z("transition-fg absolute right-2 top-2 opacity-0",{"group-focus-within:opacity-100 group-hover:opacity-100 group-focus:opacity-100":!p&&!t,"opacity-100":t}),children:e.jsx(q,{onClick:y=>{y.stopPropagation()},checked:t,onCheckedChange:o})}),e.jsx("img",{src:s.url,alt:"",className:"size-full object-cover object-center"})]})},Pe=({media:s,checked:t})=>e.jsxs("div",{className:"shadow-elevation-card-rest hover:shadow-elevation-card-hover focus-visible:shadow-borders-focus bg-ui-bg-subtle-hover group relative aspect-square h-auto max-w-full cursor-grabbing overflow-hidden rounded-lg outline-none",children:[s.isThumbnail&&e.jsx("div",{className:"absolute left-2 top-2",children:e.jsx(B,{})}),e.jsx("div",{className:z("transition-fg absolute right-2 top-2 opacity-0",{"opacity-100":t}),children:e.jsx(q,{checked:t})}),e.jsx("img",{src:s.url,alt:"",className:"size-full object-cover object-center"})]}),Ee=({product:s})=>{const{state:t}=me(),[i,a]=j.useState((t==null?void 0:t.curr)||0),{t:o}=P(),m=fe(),{mutateAsync:l,isPending:n}=H(s.id),d=_e(s.images,s.thumbnail),g=j.useCallback(()=>{n||a(c=>(c+1)%d.length)},[d,n]),h=j.useCallback(()=>{n||a(c=>(c-1+d.length)%d.length)},[d,n]),p=j.useCallback(c=>{n||a(c)},[n]),N=()=>{if(n)return;const c=document.createElement("a");c.href=d[i].url,c.download="image",c.target="_blank",c.click()},y=async()=>{var M;const c=d[i];if(!await m({title:o("general.areYouSure"),description:c.isThumbnail?o("products.media.deleteWarningWithThumbnail",{count:1}):o("products.media.deleteWarning",{count:1}),confirmText:o("actions.delete"),cancelText:o("actions.cancel")}))return;const _=((M=s.images)==null?void 0:M.filter(w=>w.id!==c.id).map(w=>({url:w.url})))||[];i===d.length-1&&a(w=>w-1),await l({images:_,thumbnail:c.isThumbnail?"":void 0})};j.useEffect(()=>{const c=S=>{S.key==="ArrowRight"?g():S.key==="ArrowLeft"&&h()};return document.addEventListener("keydown",c),()=>{document.removeEventListener("keydown",c)}},[g,h]);const E=!d.length;return e.jsxs("div",{className:"flex size-full flex-col overflow-hidden",children:[e.jsx(v.Header,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsxs(D,{size:"small",type:"button",onClick:y,disabled:E,children:[e.jsx(xe,{}),e.jsx("span",{className:"sr-only",children:o("products.media.deleteImageLabel")})]}),e.jsxs(D,{size:"small",type:"button",onClick:N,disabled:E,children:[e.jsx(pe,{}),e.jsx("span",{className:"sr-only",children:o("products.media.downloadImageLabel")})]}),e.jsx(I,{variant:"secondary",size:"small",asChild:!0,children:e.jsx(F,{to:{pathname:".",search:"view=edit"},children:o("actions.edit")})})]})}),e.jsxs(v.Body,{className:"flex flex-col overflow-hidden",children:[e.jsx(Me,{curr:i,media:d}),e.jsx(De,{curr:i,media:d,prev:h,next:g,goTo:p})]})]})},Me=({media:s,curr:t})=>{const{t:i}=P();return s.length===0?e.jsxs("div",{className:"bg-ui-bg-subtle flex size-full flex-col items-center justify-center gap-y-4 pb-8 pt-6",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx(O,{size:"small",leading:"compact",weight:"plus",className:"text-ui-fg-subtle",children:i("products.media.emptyState.header")}),e.jsx(O,{size:"small",className:"text-ui-fg-muted",children:i("products.media.emptyState.description")})]}),e.jsx(I,{size:"small",variant:"secondary",asChild:!0,children:e.jsx(F,{to:"?view=edit",children:i("products.media.emptyState.action")})})]}):e.jsx("div",{className:"bg-ui-bg-subtle relative size-full overflow-hidden",children:e.jsx("div",{className:"flex size-full items-center justify-center p-6",children:e.jsxs("div",{className:"relative inline-block max-h-full max-w-full",children:[s[t].isThumbnail&&e.jsx("div",{className:"absolute left-2 top-2",children:e.jsx(W,{content:i("products.media.thumbnailTooltip"),children:e.jsx(B,{})})}),e.jsx("img",{src:s[t].url,alt:"",className:"object-fit shadow-elevation-card-rest max-h-[calc(100vh-200px)] w-auto rounded-xl object-contain"})]})})})},V=8,De=({media:s,curr:t,prev:i,next:a,goTo:o})=>{if(!s.length)return null;const l=((n,d)=>{if(n.length<=V)return n;const g=Math.floor(V/2),h=(d-g+n.length)%n.length,p=(h+V)%n.length;return p<h?[...n.slice(h),...n.slice(0,p)]:n.slice(h,p)})(s,t);return e.jsxs("div",{className:"flex shrink-0 items-center justify-center gap-x-2 border-t p-3",children:[e.jsx(D,{size:"small",variant:"transparent",className:"text-ui-fg-muted",type:"button",onClick:i,children:e.jsx(ge,{})}),e.jsx("div",{className:"flex items-center gap-x-2",children:l.map(n=>{const d=n.id===s[t].id,g=s.findIndex(h=>h.id===n.id);return e.jsx("button",{type:"button",onClick:()=>o(g),className:z("transition-fg size-7 overflow-hidden rounded-[4px] outline-none",{"shadow-borders-focus":d}),children:e.jsx("img",{src:n.url,alt:"",className:"size-full object-cover"})},n.id)})}),e.jsx(D,{size:"small",variant:"transparent",className:"text-ui-fg-muted",type:"button",onClick:a,children:e.jsx(be,{})})]})},_e=(s,t)=>{const i=(s==null?void 0:s.map(a=>({id:a.id,url:a.url,isThumbnail:a.url===t})))||[];return t&&!i.some(a=>a.isThumbnail)&&i.unshift({id:"thumbnail_only",url:t,isThumbnail:!0}),i},Le=j.createContext(null),Ae=s=>s.get("view")==="edit"?"edit":"gallery",Ve=({product:s})=>{const[t,i]=se(),a=Ae(t),o=m=>()=>{i({view:m})};return e.jsx(Le.Provider,{value:{goToGallery:o("gallery"),goToEdit:o("edit")},children:Fe(a,s)})},Fe=(s,t)=>{switch(s){case"gallery":return e.jsx(Ee,{product:t});case"edit":return e.jsx(Se,{product:t})}},Ye=()=>{const{t:s}=P(),{id:t}=$(),{product:i,isLoading:a,isError:o,error:m}=ee(t),l=!a&&i;if(o)throw m;return e.jsxs(v,{children:[e.jsx(v.Title,{asChild:!0,children:e.jsx("span",{className:"sr-only",children:s("products.media.label")})}),e.jsx(v.Description,{asChild:!0,children:e.jsx("span",{className:"sr-only",children:s("products.media.editHint")})}),l&&e.jsx(Ve,{product:i})]})};export{Ye as Component};
