import{g as C}from"./chunk-WKOPGFW5-Di_6cJlP.js";import{a as $}from"./chunk-4XSXVVYD-C7XLEHYL.js";import{u as D}from"./chunk-HFB3OQXI-CgJWO1Kt.js";import{C as G}from"./chunk-2PMSBTXI-B-DQ21hS.js";import{K as B}from"./chunk-6HTZNHPT-XB1WuBsp.js";import{R as N,u as K}from"./chunk-4TC5YS65-CQLRrj-3.js";import{ap as W,au as Z,ar as L,aD as J,as as U,ab as Y,an as ee,bE as se,j as e,b as z,dN as ie,bX as te,r as T,aw as ne,ax as le,N as V,t as R,W as n,at as S,az as ae,B as H,av as re,af as oe,c5 as ce,I as de,b3 as ue,Z as P,X as me,s as fe}from"./index-DdOSbXML.js";import{u as xe}from"./chunk-GRT22PE5-Bh_4tQNx.js";import{A as X}from"./alert-DnYEGBLc.js";var pe=W({quantity:Z(L(),J()),location_id:L(),shipping_option_id:L().optional(),send_notification:U().optional()});function he({item:t,form:u,locationId:l,reservations:h,disabled:v}){const{t:g}=z(),{variant:f}=re(t.product_id,t.variant_id,{fields:"*inventory,*inventory.location_levels,*inventory_items"},{enabled:!!t.variant}),{availableQuantity:j,inStockQuantity:E}=T.useMemo(()=>{var a,o,c;if(!((a=f==null?void 0:f.inventory_items)!=null&&a.length)||!((o=f==null?void 0:f.inventory)!=null&&o.length)||!l)return{};const{inventory:p,inventory_items:d}=f;if(!p.every(i=>{var m;return(m=i.location_levels)==null?void 0:m.find(x=>x.location_id===l)}))return{};const _=new Map(d.map(i=>[i.inventory_item_id,i.required_quantity])),y=h==null?void 0:h.find(i=>i.line_item_id===t.id),A=(c=d.find(i=>i.inventory_item_id===(y==null?void 0:y.inventory_item_id)))==null?void 0:c.required_quantity,O=y?(y==null?void 0:y.quantity)/(A||1):0,I=p.map(i=>{var w;const m=(w=i.location_levels)==null?void 0:w.find(Q=>Q.location_id===l),x=_.get(i.id);if(!m||!x)return{availableQuantity:Number.MAX_SAFE_INTEGER,stockedQuantity:Number.MAX_SAFE_INTEGER};const M=m.available_quantity/x,k=m.stocked_quantity/x;return{availableQuantity:M,stockedQuantity:k}}),F=Math.min(...I.map(i=>i.availableQuantity)),s=Math.min(...I.map(i=>i.stockedQuantity));return F===Number.MAX_SAFE_INTEGER||s===Number.MAX_SAFE_INTEGER?{}:{availableQuantity:Math.floor(F+O),inStockQuantity:Math.floor(s)}},[f,l,h]),q=0,r=Math.min(C(t),j||Number.MAX_SAFE_INTEGER);return e.jsx("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 rounded-xl",children:e.jsxs("div",{className:"flex flex-row items-center",children:[v&&e.jsx("div",{className:"ml-4 inline-flex items-center",children:e.jsx(oe,{content:g("orders.fulfillment.disabledItemTooltip"),side:"top",children:e.jsx(ce,{className:"text-ui-tag-orange-icon"})})}),e.jsxs("div",{className:de("flex flex-1 flex-col gap-x-2 gap-y-2 border-b p-3 text-sm sm:flex-row",v&&"pointer-events-none opacity-50"),children:[e.jsxs("div",{className:"flex flex-1 items-center gap-x-3",children:[e.jsx(ue,{src:t.thumbnail}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{children:[e.jsx(P,{className:"txt-small",as:"span",weight:"plus",children:t.title}),t.variant_sku&&e.jsxs("span",{children:["(",t.variant_sku,")"]})]}),e.jsx(P,{as:"div",className:"text-ui-fg-subtle txt-small",children:t.variant_title})]})]}),e.jsxs("div",{className:"flex flex-1 items-center gap-x-1",children:[e.jsx("div",{className:"mr-2 block h-[16px] w-[2px] bg-gray-200"}),e.jsxs("div",{className:"text-small flex flex-1 flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle font-medium",children:g("orders.fulfillment.available")}),e.jsx("span",{className:"text-ui-fg-subtle",children:j||"N/A"})]}),e.jsxs("div",{className:"flex flex-1 items-center gap-x-1",children:[e.jsx("div",{className:"mr-2 block h-[16px] w-[2px] bg-gray-200"}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle font-medium",children:g("orders.fulfillment.inStock")}),e.jsxs("span",{className:"text-ui-fg-subtle",children:[E||"N/A"," ",E&&e.jsxs("span",{className:"font-medium text-red-500",children:["-",u.getValues(`quantity.${t.id}`)]})]})]})]}),e.jsxs("div",{className:"flex flex-1 items-center gap-1",children:[e.jsx(n.Field,{control:u.control,name:`quantity.${t.id}`,rules:{required:!0,min:q,max:r},render:({field:p})=>e.jsxs(n.Item,{children:[e.jsx(n.Control,{children:e.jsx(me,{className:"bg-ui-bg-base txt-small w-[50px] rounded-lg text-right [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none",type:"number",...p,onChange:d=>{const b=d.target.value===""?null:Number(d.target.value);p.onChange(b),isNaN(b)||(b<q||b>r?u.setError(`quantity.${t.id}`,{type:"manual",message:g("orders.fulfillment.error.wrongQuantity",{count:r,number:r})}):u.clearErrors(`quantity.${t.id}`))}})}),e.jsx(n.ErrorMessage,{})]})}),e.jsxs("span",{className:"text-ui-fg-subtle",children:["/ ",t.quantity," ",g("fields.qty")]})]})]})]})]})})}function ge({order:t,requiresShipping:u}){var I,F;const{t:l}=z(),{handleSuccess:h}=K(),{mutateAsync:v,isPending:g}=ie(t.id),{reservations:f}=te({line_item_id:t.items.map(s=>s.id),limit:$(t)}),j=D({queryFn:s=>fe.admin.stockLocation.list(s),queryKey:["stock_locations"],getOptions:s=>s.stock_locations.map(a=>({label:a.name,value:a.id}))}),[E,q]=T.useState(()=>(t.items||[]).filter(s=>s.requires_shipping===u&&C(s)>0)),r=ne({defaultValues:{quantity:E.reduce((s,a)=>(s[a.id]=C(a),s),{}),send_notification:!t.no_notification},resolver:le(pe)}),p=V({name:"location_id",control:r.control}),{shipping_options:d=[],isLoading:b}=xe({stock_location_id:p,fields:"+service_zone.fulfillment_set.location.id"}),_=V({name:"shipping_option_id",control:r.control}),y=r.handleSubmit(async s=>{const a=d.find(i=>i.id===_);if(!a){r.setError("shipping_option_id",{type:"manual",message:l("orders.fulfillment.error.noShippingOption")});return}if(!p){r.setError("location_id",{type:"manual",message:l("orders.fulfillment.error.noLocation")});return}let o=Object.entries(s.quantity).map(([i,m])=>({id:i,quantity:m})).filter(({quantity:i})=>!!i);if(u){const i=a==null?void 0:a.shipping_profile_id,m=t.items.reduce((x,M)=>{var k,w,Q;return x[M.id]=(Q=(w=(k=M.variant)==null?void 0:k.product)==null?void 0:w.shipping_profile)==null?void 0:Q.id,x},{});o=o.filter(({id:x})=>m[x]===i)}const c={location_id:p,shipping_option_id:_,no_notification:!s.send_notification,items:o};try{await v(c),R.success(l("orders.fulfillment.toast.created")),h(`/orders/${t.id}`)}catch(i){R.error(i.message)}});T.useEffect(()=>{var s,a;if(d!=null&&d.length){const o=(a=(s=t.shipping_methods)==null?void 0:s[0])==null?void 0:a.shipping_option_id;if(o){const c=d.find(i=>i.id===o);if(c){const i=c.service_zone.fulfillment_set.location.id;r.setValue("location_id",i),r.setValue("shipping_option_id",o||void 0)}}}},[d]);const A=(t.items||[]).map(s=>s.requires_shipping===u&&s.detail.fulfilled_quantity);T.useEffect(()=>{var o;const s=((o=t==null?void 0:t.items)==null?void 0:o.filter(c=>c.requires_shipping===u&&C(c)>0))||[];q(s),s.length?r.clearErrors("root"):r.setError("root",{type:"manual",message:l("orders.fulfillment.error.noItems")});const a=s.reduce((c,i)=>(c[i.id]=C(i),c),{});r.setValue("quantity",a)},[...A,u]);const O=_&&((F=(I=t.shipping_methods)==null?void 0:I[0])==null?void 0:F.shipping_option_id)!==_;return e.jsx(N.Form,{form:r,children:e.jsxs(B,{onSubmit:y,className:"flex h-full flex-col overflow-hidden",children:[e.jsx(N.Header,{}),e.jsx(N.Body,{className:"flex h-full w-full flex-col items-center divide-y overflow-y-auto",children:e.jsx("div",{className:"flex size-full flex-col items-center overflow-auto p-16",children:e.jsx("div",{className:"flex w-full max-w-[736px] flex-col justify-center px-2 pb-2",children:e.jsxs("div",{className:"flex flex-col divide-y divide-dashed",children:[e.jsx("div",{className:"pb-8",children:e.jsx(n.Field,{control:r.control,name:"location_id",render:({field:{...s}})=>e.jsxs(n.Item,{children:[e.jsxs("div",{className:"flex flex-col gap-2 xl:flex-row xl:items-center",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(n.Label,{children:l("fields.location")}),e.jsx(n.Hint,{children:l("orders.fulfillment.locationDescription")})]}),e.jsx("div",{className:"flex-1",children:e.jsx(n.Control,{children:e.jsx(G,{...s,options:j.options,searchValue:j.searchValue,onSearchValueChange:j.onSearchValueChange,disabled:j.disabled})})})]}),e.jsx(n.ErrorMessage,{})]})})}),e.jsxs("div",{className:"py-8",children:[e.jsx(n.Field,{control:r.control,name:"shipping_option_id",render:({field:{onChange:s,ref:a,...o}})=>e.jsxs(n.Item,{children:[e.jsxs("div",{className:"flex flex-col gap-2 xl:flex-row xl:items-center",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(n.Label,{children:l("fields.shippingMethod")}),e.jsx(n.Hint,{children:l("orders.fulfillment.methodDescription")})]}),e.jsx("div",{className:"flex-1",children:e.jsx(n.Control,{children:e.jsxs(S,{onValueChange:s,...o,disabled:!p,children:[e.jsx(S.Trigger,{className:"bg-ui-bg-base",ref:a,children:b?e.jsxs("span",{className:"text-right",children:[l("labels.loading"),"..."]}):e.jsx(S.Value,{})}),e.jsx(S.Content,{children:d.map(c=>e.jsx(S.Item,{value:c.id,children:c.name},c.id))})]})})})]}),e.jsx(n.ErrorMessage,{})]})}),O&&e.jsxs(X,{className:"mt-4 p-4",variant:"warning",children:[e.jsx("span",{className:"-mt-[3px] block font-medium",children:l("labels.beaware")}),e.jsx("span",{className:"text-ui-fg-muted",children:l("orders.fulfillment.differentOptionSelected")})]})]}),e.jsxs("div",{children:[e.jsxs(n.Item,{className:"mt-8",children:[e.jsx(n.Label,{children:l("orders.fulfillment.itemsToFulfill")}),e.jsx(n.Hint,{children:l("orders.fulfillment.itemsToFulfillDesc")}),e.jsx("div",{className:"flex flex-col gap-y-1",children:E.map(s=>{var o,c,i,m;const a=((o=d.find(x=>x.id===_))==null?void 0:o.shipping_profile_id)===((m=(i=(c=s.variant)==null?void 0:c.product)==null?void 0:i.shipping_profile)==null?void 0:m.id);return e.jsx(he,{form:r,item:s,locationId:p,disabled:u&&!a,reservations:f},s.id)})})]}),r.formState.errors.root&&e.jsx(X,{variant:"error",dismissible:!1,className:"flex items-center",classNameInner:"flex justify-between flex-1 items-center",children:r.formState.errors.root.message})]}),e.jsx("div",{className:"mt-8 pt-8 ",children:e.jsx(n.Field,{control:r.control,name:"send_notification",render:({field:{onChange:s,value:a,...o}})=>e.jsxs(n.Item,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(n.Label,{children:l("orders.returns.sendNotification")}),e.jsx(n.Control,{children:e.jsx(n.Control,{children:e.jsx(ae,{checked:!!a,onCheckedChange:s,...o})})})]}),e.jsx(n.Hint,{className:"!mt-1",children:l("orders.fulfillment.sendNotificationHint")}),e.jsx(n.ErrorMessage,{})]})})})]})})})}),e.jsx(N.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(N.Close,{asChild:!0,children:e.jsx(H,{size:"small",variant:"secondary",children:l("actions.cancel")})}),e.jsx(H,{size:"small",type:"submit",isLoading:g,disabled:!_,children:l("orders.fulfillment.create")})]})})]})})}function we(){const{id:t}=Y(),[u]=ee(),l=u.get("requires_shipping")==="true",{order:h,isLoading:v,isError:g,error:f}=se(t,{fields:"currency_code,*items,*items.variant,+items.variant.product.shipping_profile.id,*shipping_address,+shipping_methods.shipping_option_id"});if(g)throw f;const j=!v&&h;return e.jsx(N,{children:j&&e.jsx(ge,{order:h,requiresShipping:l})})}export{we as Component};
