import{u as R}from"./chunk-HFB3OQXI-CgJWO1Kt.js";import{C as ee}from"./chunk-2PMSBTXI-B-DQ21hS.js";import{r as E,j as e,b as U,e4 as se,Y as ae,N as P,e5 as te,H as le,Z as re,W as d,at as m,J as ie,a1 as de,ai as ne,B as Z,v as ce,s as ue,X as G}from"./index-DdOSbXML.js";var L=r=>(r||[]).map(s=>{var o,b;return{id:s.id,required:s.required,field_type:s.field_type,disguised:s.disguised,attribute:s.attribute,operator:s.operator,values:s.field_type==="number"||s.operator==="eq"?typeof s.values=="object"?(o=s.values[0])==null?void 0:o.value:s.values:(b=s==null?void 0:s.values)==null?void 0:b.map(g=>g.value)}}),oe=(r,s)=>{var o;return!r||!s?{}:r==="currency_code"?{value:(o=s.supported_currencies)==null?void 0:o.map(b=>b.currency_code)}:{}},xe=({form:r,identifier:s,scope:o,name:b,operator:g,fieldRule:a,attributes:v,ruleType:N,applicationMethodTargetType:j})=>{const{t:$}=U(),t=v==null?void 0:v.find(c=>c.value===a.attribute),{store:n,isLoading:S}=ce(),I=R({queryFn:async c=>await ue.admin.promotion.listRuleValues(N,t==null?void 0:t.id,{...c,...oe(t==null?void 0:t.id,n),application_method_target_type:j}),enabled:!!(t!=null&&t.id)&&["select","multiselect"].includes(t.field_type)&&!S,getOptions:c=>c.values,queryKey:["rule-value-options",N,t==null?void 0:t.id]}),f=P({control:r.control,name:g});return E.useEffect(()=>{Object.keys(r.formState.dirtyFields).length>0&&(f==="eq"?r.setValue(b,""):r.setValue(b,[]))},[f]),e.jsx(d.Field,{name:b,render:({field:{onChange:c,ref:p,...y}})=>(t==null?void 0:t.field_type)==="number"?e.jsxs(d.Item,{className:"basis-1/2",children:[e.jsx(d.Control,{children:e.jsx(G,{...y,type:"number",onChange:c,className:"bg-ui-bg-base",ref:p,min:1,disabled:!a.attribute})}),e.jsx(d.ErrorMessage,{})]}):(t==null?void 0:t.field_type)==="text"?e.jsxs(d.Item,{className:"basis-1/2",children:[e.jsx(d.Control,{children:e.jsx(G,{...y,ref:p,onChange:c,className:"bg-ui-bg-base",disabled:!a.attribute})}),e.jsx(d.ErrorMessage,{})]}):e.jsxs(d.Item,{className:"basis-1/2",children:[e.jsx(d.Control,{children:e.jsx(ee,{...y,...I,ref:p,placeholder:$(f==="eq"?"labels.selectValue":"labels.selectValues"),disabled:!f,onChange:c})}),e.jsx(d.ErrorMessage,{})]})},`${s}.${o}.${b}-${a.attribute}`)},Q={id:"product",attribute:"items.product.id",attribute_label:"Product",operator:"eq",operator_label:"Equal",values:[],required:!0,field_type:"select",disguised:!1},pe=({form:r,ruleType:s,setRulesToRemove:o,rulesToRemove:b,scope:g="rules",promotion:a,formType:v="create"})=>{var X,J,K;const N=E.useRef(!1),{t:j}=U(),$=r.getValues(),{attributes:t}=se(s,$.type,(X=$.application_method)==null?void 0:X.target_type),{fields:n,append:S,remove:I,update:f,replace:c}=ae({control:r.control,name:g,keyName:g}),p=P({control:r.control,name:"type",defaultValue:a==null?void 0:a.type}),y=P({control:r.control,name:"application_method.type",defaultValue:(J=a==null?void 0:a.application_method)==null?void 0:J.type}),M=P({control:r.control,name:"application_method.target_type",defaultValue:(K=a==null?void 0:a.application_method)==null?void 0:K.target_type}),O=p?{promotion_type:p,application_method_type:y,application_method_target_type:M}:{},{rules:_,isLoading:W}=te((a==null?void 0:a.id)||null,s,O,{enabled:!!(a!=null&&a.id)||!!p&&!!y});return E.useEffect(()=>{if(!W&&!(!n.length&&v==="edit"&&N.current)){if(s==="rules"&&!n.length&&(r.resetField("rules"),c(L(_))),s==="buy-rules"&&!n.length){r.resetField("application_method.buy_rules");const i=a!=null&&a.id||p==="standard"?_:[..._,Q];c(L(i))}if(s==="target-rules"&&!n.length){r.resetField("application_method.target_rules");const i=a!=null&&a.id||p==="standard"?_:[..._,Q];c(L(i))}N.current=!0}},[p,W,s,n.length,v,r,c,_,a==null?void 0:a.id]),e.jsxs("div",{className:"flex flex-col",children:[e.jsx(le,{level:"h2",className:"mb-2",children:j(s==="target-rules"?`promotions.fields.conditions.${s}.${M}.title`:`promotions.fields.conditions.${s}.title`)}),e.jsx(re,{className:"text-ui-fg-subtle txt-small mb-6",children:j(s==="target-rules"?`promotions.fields.conditions.${s}.${M}.description`:`promotions.fields.conditions.${s}.description`)}),n.map((i,x)=>{const q=i.id;return e.jsxs(E.Fragment,{children:[e.jsxs("div",{className:"bg-ui-bg-subtle border-ui-border-base flex flex-row gap-2 rounded-xl border px-2 py-2",children:[e.jsxs("div",{className:"grow",children:[e.jsx(d.Field,{name:`${g}.${x}.attribute`,render:({field:F})=>{var V;const{onChange:z,ref:A,...w}=F,C=(n==null?void 0:n.map(l=>l.attribute))||[],u=(t==null?void 0:t.filter(l=>l.value===i.attribute?!0:!C.includes(l.value)))||[],B=!!i.required,D=l=>{var Y;const h=u.find(T=>T.id===l),k={...i,disguised:(h==null?void 0:h.disguised)||!1};((Y=h==null?void 0:h.operators)==null?void 0:Y.length)===1&&(k.operator=h.operators[0].value),k.operator==="eq"?k.values="":k.values=[],f(x,k),z(l)};return e.jsxs(d.Item,{className:"mb-2",children:[i.required&&e.jsx("div",{className:"flex items-center px-2",children:e.jsx("p",{className:"text text-ui-fg-muted txt-small",children:j("promotions.form.required")})}),e.jsx(d.Control,{children:B?e.jsx(H,{label:((V=u==null?void 0:u.find(l=>l.value===i.attribute))==null?void 0:V.label)||"",field:F}):e.jsxs(m,{...w,onValueChange:D,disabled:i.required,children:[e.jsx(m.Trigger,{ref:A,className:"bg-ui-bg-base",children:e.jsx(m.Value,{placeholder:j("promotions.form.selectAttribute")})}),e.jsx(m.Content,{children:u==null?void 0:u.map((l,h)=>e.jsx(m.Item,{value:l.value,children:e.jsx("span",{className:"text-ui-fg-subtle",children:l.label})},`${q}-attribute-option-${h}`))})]})}),e.jsx(d.ErrorMessage,{})]})}}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d.Field,{name:`${g}.${x}.operator`,render:({field:F})=>{var D,V;const{onChange:z,ref:A,...w}=F,C=t==null?void 0:t.find(l=>l.value===i.attribute),u=((D=C==null?void 0:C.operators)==null?void 0:D.map((l,h)=>({label:l.label,value:l.value,key:`${q}-operator-option-${h}`})))||[],B=!!i.attribute&&(u==null?void 0:u.length)<=1;return e.jsxs(d.Item,{className:"basis-1/2",children:[e.jsx(d.Control,{children:B?e.jsx(H,{label:((V=u.find(l=>l.value===w.value))==null?void 0:V.label)||"",field:F}):e.jsxs(m,{...w,disabled:!i.attribute,onValueChange:z,children:[e.jsx(m.Trigger,{ref:A,className:"bg-ui-bg-base",children:e.jsx(m.Value,{placeholder:"Select Operator"})}),e.jsx(m.Content,{children:u==null?void 0:u.map(l=>e.jsx(m.Item,{value:l.value,children:e.jsx("span",{className:"text-ui-fg-subtle",children:l.label})},l.key))})]})}),e.jsx(d.ErrorMessage,{})]})}}),e.jsx(xe,{form:r,identifier:q,scope:g,name:`${g}.${x}.values`,operator:`${g}.${x}.operator`,fieldRule:i,attributes:t,ruleType:s,applicationMethodTargetType:M})]})]}),e.jsx("div",{className:"size-7 flex-none self-center",children:!i.required&&e.jsx(ie,{size:"small",variant:"transparent",className:"text-ui-fg-muted",type:"button",onClick:()=>{i.required||(o&&o([...b,i]),I(x))},children:e.jsx(de,{})})})]}),x<n.length-1&&e.jsxs("div",{className:"relative px-6 py-3",children:[e.jsx("div",{className:"border-ui-border-strong absolute bottom-0 left-[40px] top-0 z-[-1] w-px bg-[linear-gradient(var(--border-strong)_33%,rgba(255,255,255,0)_0%)] bg-[length:1px_3px] bg-repeat-y"}),e.jsx(ne,{size:"2xsmall",className:" text-xs",children:j("promotions.form.and")})]})]},`${i.id}.${x}.${i.attribute}`)}),e.jsxs("div",{className:n.length?"mt-6":"",children:[e.jsx(Z,{type:"button",variant:"secondary",className:"inline-block",onClick:()=>{S({attribute:"",operator:"",values:[],required:!1})},children:j("promotions.fields.addCondition")}),!!n.length&&e.jsx(Z,{type:"button",variant:"transparent",className:"text-ui-fg-muted hover:text-ui-fg-subtle ml-2 inline-block",onClick:()=>{const i=n.map((x,q)=>x.required?null:q).filter(x=>x!==null);o&&o(n.filter(x=>!x.required)),I(i)},children:j("promotions.fields.clearAll")})]})]})},H=E.forwardRef(({label:r,field:s},o)=>e.jsxs("div",{children:[e.jsx("div",{className:"txt-compact-small bg-ui-bg-component shadow-borders-base text-ui-fg-base h-8 rounded-md px-2 py-1.5",children:r}),e.jsx("input",{...s,ref:o,disabled:!0,hidden:!0})]}));H.displayName="DisabledField";export{pe as R};
