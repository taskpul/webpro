# Tenant Module

The tenant module manages the registry of storefront tenants for the Medusa
backend and provisions isolated PostgreSQL databases (one per tenant) with a
default admin user. It is designed for multisite installations â€“ for example a
WordPress Multisite network that needs each storefront tenant to map to its own
subdomain and data store.

## Registration

Add the module registration to your Medusa container loader. When the module is
registered the `tenantService` token becomes available through the request
scope.

```ts
import registerTenantModule from "./src/modules/tenant"

registerTenantModule(container, {
  rootDomain: process.env.ROOT_DOMAIN!,
  database: {
    host: process.env.DB_HOST!,
    port: Number(process.env.DB_PORT || 5432),
    user: process.env.DB_USER!,
    password: process.env.DB_PASS!,
  },
  admin: {
    role: "admin",
    promoteToSuperAdmin: true,
    bcryptSaltRounds: 12,
  },
})
```

## Options

| Option                               | Default                | Description |
| ------------------------------------ | ---------------------- | ----------- |
| `rootDomain`                         | `example.com`          | Base domain appended to autogenerated subdomains. |
| `database.host`                      | `process.env.DB_HOST`  | PostgreSQL host used for tenant DB creation. |
| `database.port`                      | `process.env.DB_PORT`  | PostgreSQL port. |
| `database.user`                      | `process.env.DB_USER`  | Superuser with permission to create/drop databases. |
| `database.password`                  | `process.env.DB_PASS`  | Password for the database user. |
| `database.ssl`                       | `undefined`            | Optional SSL settings passed to the `pg` client. |
| `admin.role`                         | `admin`                | Role assigned to the autogenerated tenant admin. |
| `admin.promoteToSuperAdmin`          | `true`                 | Whether the admin receives super-admin privileges. |
| `admin.bcryptSaltRounds`             | `10`                   | Salt rounds used when hashing the admin password. |

> **Important:** `database.user` and `database.password` must be set either in
> the options or environment variables. The credentials are required to create
> and destroy tenant databases.

## Service API

The module exports the `tenantService` token and related types for container
resolution.

```ts
import { TENANT_SERVICE, TenantService } from "@modules/tenant"

const tenantService = scope.resolve<TenantService>(TENANT_SERVICE)

await tenantService.create({
  name: "demo",
  adminEmail: "admin@demo.test",
  adminPassword: process.env.DEMO_ADMIN_PASS!,
})
```

### `create`

Creates (or reuses) a tenant database, provisions the tenant admin, and stores
the registry entry in the primary Medusa database. The method accepts the
following payload:

```ts
tenantService.create({
  name: "tenant-a",             // required, used to generate slug and db name
  adminEmail: "owner@a.test",   // required, login for the admin
  adminPassword: "strong-pass", // required, hashed with bcrypt
  subdomain: "shop.example.com",// optional override
  dbName: "db_tenant_a",        // optional override
})
```

This method enforces unique registry entries and is idempotent for database and
admin provisioning: if the database already exists or the admin email is in use
the records are updated rather than duplicated.

### `delete`

```ts
await tenantService.delete({ name: "tenant-a" })
```

Removes the tenant registry entry and drops the dedicated database. You can also
delete by `id` when the tenant UUID is known.

### `list`

Returns the tenants ordered by creation time. This is used by both admin and
public APIs to display available sites in a multisite environment.

## Multisite Considerations

- Each tenant receives a predictable subdomain (`<slug>.<rootDomain>` by
  default) so it can be mapped to a WordPress Multisite site record.
- The service enforces the tenant registry schema automatically if migrations
  have not been executed yet. This keeps the registry consistent for new
  environments or automated deployments.
- Admins are created inside the tenant database without invoking shell commands,
  which allows provisioning in containerized or serverless environments where
  shell access may be restricted.

## Testing

Run the unit suite with:

```bash
yarn --cwd back test:unit
```

The tests cover database provisioning, admin bootstrapping, deletion and option
handling, ensuring the module behaves predictably in multisite installations.
